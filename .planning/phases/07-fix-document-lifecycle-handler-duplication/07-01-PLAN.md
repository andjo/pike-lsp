---
phase: 07-fix-document-lifecycle-handler-duplication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/pike-lsp-server/src/server.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Document lifecycle handlers only registered once (in diagnostics.ts)"
    - "All 7 E2E tests pass (symbols, hover, definition, completion)"
    - "Document cache populates reliably on file open"
    - "No duplicate handler registration"
  artifacts:
    - path: "packages/pike-lsp-server/src/server.ts"
      provides: "Server wiring without duplicate lifecycle handlers"
      contains: "registerDiagnosticsHandlers"
      not_contains: "documents.onDidOpen"
  key_links:
    - from: "server.ts"
      to: "features/diagnostics.ts"
      via: "registerDiagnosticsHandlers()"
      pattern: "features\\.registerDiagnosticsHandlers"
---

<objective>
Remove duplicate document lifecycle handlers from server.ts that cause E2E test failures.

Purpose: Close GAP-01 from v2-MILESTONE-AUDIT.md. During Phase 4 (Server Grouping), `registerDiagnosticsHandlers()` was created in diagnostics.ts but the original handlers in server.ts (lines 583-608) were NOT removed, causing duplicate registration. When both fire, race conditions corrupt the document cache, breaking LSP features (symbols, hover, go-to-definition).

Output: server.ts with duplicate handlers removed, all 7 E2E tests passing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v2-MILESTONE-AUDIT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove duplicate lifecycle handlers from server.ts</name>
  <files>packages/pike-lsp-server/src/server.ts</files>
  <action>
Remove lines 579-608 from server.ts (the "Document Lifecycle Handlers" section).

These lines to remove:
```typescript
// ============================================================================
// Document Lifecycle Handlers
// ============================================================================

documents.onDidOpen((event) => {
    connection.console.log(`Document opened: ${event.document.uri}`);
    validateDocument(event.document);
});

documents.onDidChangeContent((change) => {
    validateDocumentDebounced(change.document);
});

documents.onDidSave((event) => {
    validateDocument(event.document);
});

documents.onDidClose((event) => {
    documentCache.delete(event.document.uri);
    typeDatabase.removeProgram(event.document.uri);
    workspaceIndex.removeDocument(event.document.uri);

    const timer = validationTimers.get(event.document.uri);
    if (timer) {
        clearTimeout(timer);
        validationTimers.delete(event.document.uri);
    }

    connection.sendDiagnostics({ uri: event.document.uri, diagnostics: [] });
});
```

Keep the handlers in `features/diagnostics.ts` (lines 547-601) - they are comprehensive with proper error handling via try/catch and logging.

WHY: The diagnostics.ts version includes:
- try/catch blocks around each handler
- Error logging via log.error()
- void keyword for async validateDocument calls
- Comments explaining each handler's purpose

The server.ts version is simpler and was left behind during Phase 4 refactoring. When both register handlers on the same documents object, race conditions occur.
  </action>
  <verify>
Run TypeScript build to ensure no compile errors:
```bash
cd /home/smuks/OpenCode/pike-lsp && pnpm -r build
```
  </verify>
  <done>
Lines 579-608 removed from server.ts. The "Document Lifecycle Handlers" section no longer exists in server.ts. Only registerDiagnosticsHandlers() call remains (line 616 after removal becomes ~587).
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify E2E tests pass</name>
  <files>packages/vscode-pike/src/test/integration/lsp-features.test.ts</files>
  <action>
Run the E2E feature tests to verify the fix resolved the duplicate handler issue.

Execute:
```bash
cd /home/smuks/OpenCode/pike-lsp/packages/vscode-pike && pnpm run test:features
```

Expected result: All 7 tests pass:
1. Document symbols returns valid symbol tree
2. Hover returns type information (int variable)
3. Go-to-definition returns location
4. Completion returns suggestions
5. Completion triggers on partial word
6. Hover on function shows signature information
7. Class symbol appears in document symbols

If any test fails, check:
- Pike analyzer compiles: `pike -e 'compile_file("pike-scripts/analyzer.pike");'`
- Bridge works: `cd packages/pike-bridge && pnpm test`
- LSP server build succeeded: `pnpm --filter pike-lsp-server build`
  </action>
  <verify>
E2E test output shows 7 passing tests, 0 failing.
  </verify>
  <done>
All 7 E2E tests pass. Document cache populates reliably. LSP features (symbols, hover, definition, completion) work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite verification</name>
  <files></files>
  <action>
Run the complete test suite to ensure no regressions:

```bash
cd /home/smuks/OpenCode/pike-lsp

# Bridge unit tests
pnpm --filter pike-bridge test

# Smoke tests
pnpm --filter pike-lsp-server test:smoke

# Pike module tests
pike -e 'compile_file("pike-scripts/analyzer.pike");'
```

All tests should pass. The smoke tests verify:
- Bridge lifecycle (start/stop without crash)
- Parse returns array
- Introspect returns data
- Invalid Pike returns error (not crash)
  </action>
  <verify>
All test suites pass:
- pike-bridge: 6+ passing
- pike-lsp-server smoke: 4 passing
- Pike compilation: exits 0
  </verify>
  <done>
Full test suite passes. No regressions introduced by the fix.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Duplicate handlers removed:**
   ```bash
   grep -n "documents.onDidOpen" packages/pike-lsp-server/src/server.ts
   # Should return NO matches (handlers only in diagnostics.ts)
   ```

2. **Feature registration still works:**
   ```bash
   grep -n "registerDiagnosticsHandlers" packages/pike-lsp-server/src/server.ts
   # Should show the registration call is still present
   ```

3. **E2E tests all pass:**
   ```bash
   cd packages/vscode-pike && pnpm run test:features
   # 7 passing, 0 failing
   ```
</verification>

<success_criteria>
- [ ] Lines 579-608 removed from server.ts
- [ ] TypeScript builds without errors
- [ ] All 7 E2E tests pass
- [ ] Smoke tests pass (no regression)
- [ ] Bridge tests pass (no regression)
- [ ] Pike analyzer compiles
- [ ] No "documents.onDidOpen" in server.ts (only in diagnostics.ts)
</success_criteria>

<output>
After completion, create `.planning/phases/07-fix-document-lifecycle-handler-duplication/07-01-SUMMARY.md`
</output>
