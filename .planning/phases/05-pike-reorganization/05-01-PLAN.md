---
phase: 05-pike-reorganization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pike-scripts/LSP.pmod/Intelligence.pmod/module.pmod
  - pike-scripts/LSP.pmod/Intelligence.pmod/Introspection.pike
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Intelligence.pmod directory exists with module.pmod and Introspection.pike"
    - "module.pmod contains shared helper functions for AutoDoc parsing"
    - "Introspection class uses create(object ctx) constructor pattern"
    - "handle_introspect wraps work in catch with LSPError response"
    - "master()->resolv('LSP.Intelligence.Introspection') returns the class"
  artifacts:
    - path: "pike-scripts/LSP.pmod/Intelligence.pmod/module.pmod"
      provides: "Shared AutoDoc and markup parsing helpers"
      min_lines: 50
    - path: "pike-scripts/LSP.pmod/Intelligence.pmod/Introspection.pike"
      provides: "Introspection class with handle_introspect handler"
      min_lines: 300
  key_links:
    - from: "pike-scripts/LSP.pmod/Intelligence.pmod/Introspection.pike"
      to: "pike-scripts/LSP.pmod/Intelligence.pmod/module.pmod"
      via: "Direct function calls (extract_autodoc_comments, process_inline_markup)"
      pattern: "extract_autodoc_comments|process_inline_markup"
---

<objective>
Create the Intelligence.pmod directory structure with shared helpers and Introspection class.

Purpose: Establish the .pmod module pattern for splitting Intelligence.pike, starting with shared helpers in module.pmod and the Introspection class for symbol extraction.
Output: Intelligence.pmod/ directory with module.pmod (AutoDoc helpers) and Introspection.pike (symbol extraction class)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase intelligence
@.planning/intel/summary.md

# Phase context
@.planning/phases/05-pike-reorganization/05-CONTEXT.md
@.planning/phases/05-pike-reorganization/05-RESEARCH.md

# Source files to split
@pike-scripts/LSP.pmod/Intelligence.pike
@pike-scripts/LSP.pmod/module.pmod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Intelligence.pmod directory with module.pmod</name>
  <files>pike-scripts/LSP.pmod/Intelligence.pmod/module.pmod</files>
  <action>
    Create directory pike-scripts/LSP.pmod/Intelligence.pmod/

    Create module.pmod with shared helper functions extracted from Intelligence.pike:
    1. extract_autodoc_comments() - Extract //! comments from source code
    2. extract_symbol_name() - Extract function name from definition line
    3. process_inline_markup() - Convert AutoDoc inline tags to markdown (@i{}, @b{}, @tt{}, @ref{}, @expr{}, @[name])
    4. replace_markup() - Helper for replacing markup tags

    Pattern:
    - Use //! for function documentation
    - Functions should be callable directly from classes in the .pmod
    - No class wrapper in module.pmod (functions are merged into module namespace)

    DO NOT include the following (they go in other files):
    - save_text_buffer, format_group_as_text (AutoDoc output formatting - goes in TypeAnalysis.pike)
    - parse_autodoc, parse_autodoc_impl (AutoDoc parsing logic - goes in TypeAnalysis.pike)
  </action>
  <verify>pike -e 'master()->add_module_path("pike-scripts"); mixed m = master()->resolv("LSP.Intelligence.extract_autodoc_comments"); if (functionp(m)) { werror("OK: extract_autodoc_comments is a function\n"); } else { werror("FAIL: extract_autodoc_comments not found\n"; exit(1); }'</verify>
  <done>module.pmod exists with 4 shared helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Create Introspection.pike with Introspection class</name>
  <files>pike-scripts/LSP.pmod/Intelligence.pmod/Introspection.pike</files>
  <action>
    Create Introspection.pike with class Introspection that contains:

    1. Private object context field
    2. void create(object ctx) constructor
    3. mapping handle_introspect(mapping params) - main handler
    4. protected mapping handle_introspect_parser_only(mapping params) - for #require files
    5. protected mapping introspect_program(program prog) - core introspection
    6. protected object safe_instantiate(program prog) - timeout-safe instantiation
    7. protected int is_lsp_module_file(string filename)
    8. protected string path_to_module_name(string filename)

    Handler pattern:
    - Wrap handler body in catch { ... }
    - On error: return LSP.module.LSPError(-32000, describe_error(err))->to_response()
    - Use LSP.Compat.trim_whites() for string operations
    - Use LSP.Cache.put() for caching compiled programs

    Include constants at top:
    - constant Cache = LSP.Cache; (for sibling module access)

    Use helper functions from module.pmod directly:
    - extract_autodoc_comments(code)
    - process_inline_markup(text)
    - replace_markup(text, open, close, md_open, md_close)

    DO NOT include (these stay in original Intelligence.pike for now):
    - handle_resolve, handle_resolve_stdlib, get_module_path, read_source_file (go to Resolution.pike)
    - handle_get_inherited, parse_autodoc functions (go to TypeAnalysis.pike)
  </action>
  <verify>pike -e 'master()->add_module_path("pike-scripts"); mixed m = master()->resolv("LSP.Intelligence.Introspection"); if (programp(m)) { object i = m(0); werror("OK: Introspection class instantiated\n"); } else { werror("FAIL: Introspection class not found\n"); exit(1); }'</verify>
  <done>Introspection class with create() constructor and handle_introspect method</done>
</task>

<task type="auto">
  <name>Task 3: Verify module loading and create summary</name>
  <files></files>
  <action>
    Run module loading verification:
    1. Test that LSP.Intelligence module loads
    2. Test that LSP.Intelligence.Introspection class exists
    3. Test that module.pmod functions are accessible

    Verification command:
    pike -e '
      master()->add_module_path("pike-scripts");
      mixed mod = master()->resolv("LSP.Intelligence");
      if (!mod) { werror("FAIL: LSP.Intelligence not loaded\n"); exit(1); }
      werror("OK: LSP.Intelligence loaded\n");

      mixed cls = mod->Introspection;
      if (!programp(cls)) { werror("FAIL: Introspection class not found\n"); exit(1); }
      werror("OK: Introspection class found\n");

      object inst = cls(0);
      werror("OK: Introspection instantiated\n");

      // Test that module.pmod functions are accessible
      if (!functionp(mod->extract_autodoc_comments)) {
        werror("FAIL: extract_autodoc_comments not found in module\n"); exit(1);
      }
      werror("OK: extract_autodoc_comments accessible\n");
    '

    Create summary at .planning/phases/05-pike-reorganization/05-01-SUMMARY.md
  </action>
  <verify>Summary file exists and verification commands pass</verify>
  <done>Module loads correctly, summary created</done>
</task>

</tasks>

<verification>
## Module Loading Tests

Run after completion:
```bash
pike -e '
  master()->add_module_path("pike-scripts");
  mixed mod = master()->resolv("LSP.Intelligence");
  if (!mod) { werror("FAIL\n"); exit(1); }
  if (!programp(mod->Introspection)) { werror("FAIL\n"); exit(1); }
  object i = mod->Introspection(0);
  werror("PASS\n");
'
```

## File Structure Verification

- [ ] pike-scripts/LSP.pmod/Intelligence.pmod/ exists
- [ ] pike-scripts/LSP.pmod/Intelligence.pmod/module.pmod exists (50+ lines)
- [ ] pike-scripts/LSP.pmod/Intelligence.pmod/Introspection.pike exists (300+ lines)
- [ ] Original Intelligence.pike still exists (not deleted yet)
</verification>

<success_criteria>
1. Intelligence.pmod directory exists with module.pmod and Introspection.pike
2. module.pmod contains extract_autodoc_comments, extract_symbol_name, process_inline_markup, replace_markup
3. Introspection class has create(object ctx) constructor
4. handle_introspect uses catch/LSPError error handling
5. master()->resolv("LSP.Intelligence.Introspection") returns the class program
6. Original Intelligence.pike still exists (not deleted in this plan)
</success_criteria>

<output>
After completion, create `.planning/phases/05-pike-reorganization/05-01-SUMMARY.md`
</output>
