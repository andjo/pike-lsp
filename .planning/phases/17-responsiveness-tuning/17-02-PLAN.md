---
phase: 17-responsiveness-tuning
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/vscode-pike/src/test/integration/responsiveness.test.ts
  - packages/vscode-pike/test-workspace/test-typing.pike
autonomous: false

must_haves:
  truths:
    - "Rapid typing test simulates 10 keystrokes/second for 5 seconds"
    - "Test verifies typing completes without blocking UI"
    - "Test verifies debouncing coalesces rapid edits into single validation"
  artifacts:
    - path: "packages/vscode-pike/src/test/integration/responsiveness.test.ts"
      provides: "Typing simulation E2E test"
      min_lines: 50
      exports: ["Debouncing prevents CPU thrashing during rapid typing"]
    - path: "packages/vscode-pike/test-workspace/test-typing.pike"
      provides: "Test fixture for responsiveness tests"
      min_lines: 10
  key_links:
    - from: "responsiveness.test.ts"
      to: "test-typing.pike"
      via: "vscode.Uri.joinPath(workspaceFolder.uri, 'test-typing.pike')"
      pattern: "test-typing.pike"
    - from: "responsiveness.test.ts"
      to: "packages/vscode-pike/src/extension.ts"
      via: "vscode.extensions.getExtension('pike-lsp.vscode-pike')"
      pattern: "getExtension"
---

<objective>
Create E2E test that verifies debouncing prevents CPU thrashing during rapid typing.

Purpose: Validate that 250ms debounce delay successfully coalesces rapid edits into single validations, preventing excessive CPU usage while maintaining responsive UI.

Output: New test file with typing simulation test that runs in CI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-responsiveness-tuning/17-CONTEXT.md
@.planning/phases/17-responsiveness-tuning/17-RESEARCH.md

@packages/vscode-pike/src/test/integration/lsp-features.test.ts
</context>

<tasks>

<task type="auto">
  <name>Create test fixture file for typing simulation</name>
  <files>packages/vscode-pike/test-workspace/test-typing.pike</files>
  <action>
    Create a simple valid Pike file as a starting point for typing tests.

    Content:
    ```pike
    // Test fixture for responsiveness typing simulation
    // This file will be edited rapidly during E2E tests

    int x;

    void test_function() {
        // Function body
    }

    class TestClass {
        // Class members
    }
    ```

    The actual content doesn't matter much - the test will append lines to simulate typing.
  </action>
  <verify>test -f packages/vscode-pike/test-workspace/test-typing.pike</verify>
  <done>Test fixture file exists</done>
</task>

<task type="auto">
  <name>Create responsiveness.test.ts with typing simulation</name>
  <files>packages/vscode-pike/src/test/integration/responsiveness.test.ts</files>
  <action>
    Create new test file following the pattern from lsp-features.test.ts:

    Structure:
    ```typescript
    import * as vscode from 'vscode';
    import * as assert from 'assert';

    suite('Responsiveness E2E Tests', () => {
        let workspaceFolder: vscode.WorkspaceFolder;
        let fixtureUri: vscode.Uri;
        let document: vscode.TextDocument;

        suiteSetup(async function() {
            this.timeout(60000);

            workspaceFolder = vscode.workspace.workspaceFolders?.[0]!;
            assert.ok(workspaceFolder, 'Workspace folder should exist');

            const extension = vscode.extensions.getExtension('pike-lsp.vscode-pike');
            assert.ok(extension, 'Extension should be found');

            if (!extension.isActive) {
                await extension.activate();
            }

            // Open test-typing.pike fixture
            fixtureUri = vscode.Uri.joinPath(workspaceFolder.uri, 'test-typing.pike');
            document = await vscode.workspace.openTextDocument(fixtureUri);
            await vscode.window.showTextDocument(document);

            // Wait for LSP initialization
            await new Promise(resolve => setTimeout(resolve, 15000));
        });

        suiteTeardown(async () => {
            if (document) {
                await vscode.commands.executeCommand('workbench.action.closeActiveEditor');
            }
        });

        test('Debouncing prevents CPU thrashing during rapid typing', async function() {
            this.timeout(30000);

            const editor = await vscode.window.showTextDocument(document);
            const startTime = Date.now();

            // Simulate rapid typing: 10 keystrokes/second for 5 seconds = 50 edits
            for (let i = 0; i < 50; i++) {
                // Wait 100ms between keystrokes (10 per second)
                await new Promise(resolve => setTimeout(resolve, 100));

                // Type a character at the end
                await editor.edit(editBuilder => {
                    editBuilder.insert(new vscode.Position(i, 0), 'x\n');
                });
            }

            const elapsed = Date.now() - startTime;

            // Verify typing completed in reasonable time
            // 50 edits * 100ms = 5000ms minimum, plus overhead
            assert.ok(elapsed < 10000, `Typing should complete within 10 seconds (took ${elapsed}ms)`);

            // Verify we can still interact with LSP (debounce didn't block)
            const symbols = await vscode.commands.executeCommand<vscode.DocumentSymbol[]>(
                'vscode.executeDocumentSymbolProvider',
                fixtureUri
            );
            assert.ok(symbols, 'Document symbols should still be accessible after rapid typing');
        });
    });
    ```

    Key points:
    - Follow lsp-features.test.ts pattern for setup/teardown
    - Use 100ms delay between edits (10 chars/second = fast typist)
    - 50 iterations = 5 seconds of typing simulation
    - Verify total time < 10 seconds (allows for debounce overhead)
    - Verify LSP still responsive after typing
  </action>
  <verify>test -f packages/vscode-pike/src/test/integration/responsiveness.test.ts</verify>
  <done>Responsiveness test file created with typing simulation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    - test-typing.pike fixture file
    - responsiveness.test.ts with rapid typing simulation test
  </what-built>
  <how-to-verify>
    Run the new E2E test:
    ```bash
    cd packages/vscode-pike && pnpm test:headless --grep "Debouncing prevents CPU thrashing"
    ```

    Expected behavior:
    - Test simulates 50 rapid edits over 5 seconds
    - Total elapsed time < 10 seconds
    - LSP still responds after typing (symbols query works)

    Manual verification (optional):
    1. Open a .pike file in VSCode
    2. Type rapidly for several seconds
    3. Observe that diagnostics don't appear on every keystroke
    4. Diagnostics appear ~250ms after you stop typing
  </how-to-verify>
  <resume-signal>Type "approved" if test passes, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Test must pass:
```bash
cd packages/vscode-pike && pnpm test:headless --grep "Debouncing prevents CPU thrashing"
```
</verification>

<success_criteria>
- [x] test-typing.pike fixture exists in test-workspace
- [x] responsiveness.test.ts created with typing simulation
- [x] Test passes (typing completes < 10s, LSP still responsive)
- [x] Test file follows lsp-features.test.ts patterns
</success_criteria>

<output>
After completion, create `.planning/phases/17-responsiveness-tuning/17-02-SUMMARY.md`
</output>
