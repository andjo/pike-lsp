# Pike Scripts - LSP Analyzer

## CRITICAL: Architecture Invariants

### Stdin Reading - DO NOT CHANGE

The main loop in `analyzer.pike` **MUST** use line-by-line reading:

```pike
// CORRECT - line-by-line loop
while ((line = Stdio.stdin.gets())) {
    // process line...
}
```

**NEVER** use `Stdio.stdin->read()` which waits for EOF and breaks IPC:

```pike
// WRONG - blocks until stdin closes, breaks bridge communication
string data = Stdio.stdin->read();  // DO NOT USE
```

This broke the LSP in Jan 2026 and required manual debugging to fix.

### Pike Version Compatibility

- Use `String.trim_all_whites()` not `String.trim()` (not available in Pike 8.0)
- Test with Pike 8.0.x (the target version)

## Mandatory E2E Testing

Before committing changes to pike-scripts/, you MUST verify:

### 1. Pike Bridge Communication

```bash
# Test introspect works through the bridge
node -e "
import('/home/smuks/OpenCode/pike-lsp/packages/pike-bridge/dist/index.js').then(async ({PikeBridge}) => {
  const bridge = new PikeBridge();
  await bridge.start();
  const result = await bridge.introspect('class Foo { int x; }', '/tmp/test.pike');
  console.log('Introspect:', result.success ? 'OK' : 'FAILED');
  await bridge.stop();
});
"
```

### 2. LSP Document Symbols

```bash
# Test that document symbols return data (not null)
# See /tmp/test-lsp-symbols.js for full test
```

### 3. LSP Hover

```bash
# Test that hover returns content (not null)
# See /tmp/test-lsp-hover.js for full test
```

## File Structure

- `analyzer.pike` - Main entry point, JSON-RPC router
- `LSP.pmod/` - Module directory
  - `Parser.pike` - Parsing and tokenization
  - `Intelligence.pike` - Introspection, resolution, inheritance
  - `Analysis.pike` - Diagnostics, completions, occurrences
  - `Cache.pmod` - Caching utilities
  - `Compat.pmod` - Pike version compatibility

## Testing Commands

```bash
# Verify Pike script compiles
pike -e 'compile_file("pike-scripts/analyzer.pike");'

# Direct analyzer test
echo '{"jsonrpc":"2.0","id":1,"method":"parse","params":{"code":"int x;"}}' | pike pike-scripts/analyzer.pike

# Full test suite
pnpm test
```

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Jan 19, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #3737 | 8:11 PM | ðŸ”µ | Source Analyzer Files Located | ~181 |
| #3502 | 5:52 PM | ðŸ”µ | Pike analyzer script implements preprocessor directive handling for conditional compilation | ~404 |
| #3424 | 5:01 PM | ðŸ”µ | Pike LSP analyzer script implements JSON-RPC protocol | ~373 |
| #3391 | 4:47 PM | ðŸ”µ | Pike analyzer script syntax verification | ~149 |

### Jan 20, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #4403 | 2:07 PM | âœ… | Pike LSP Extension Rebundled with Latest Modules | ~313 |
</claude-mem-context>