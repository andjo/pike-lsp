# Pike LSP Project Guidelines

## MANDATORY: E2E Verification Before Commits

**DO NOT commit changes without verifying LSP functionality works end-to-end.**

Previous agents broke the LSP by:
1. Not testing with the actual VSCode extension
2. Not checking Pike bridge communication works
3. Not looking at debug/error output from Pike subprocess

### Automated Verification (Run These First)

**VSCode E2E Feature Tests** (REQUIRED):
```bash
# Tests LSP features end-to-end: symbols, hover, definition, completion
cd packages/vscode-pike && pnpm run test:features
```

These tests verify:
- Document symbols populate outline (not null)
- Hover shows type information (not empty)
- Go-to-definition navigates (not null)
- Completion returns suggestions (not empty)

**If E2E tests pass, LSP features work.** If they fail, debug before committing.

**Note:** Pre-push hook runs these automatically, but run manually for faster feedback.

### Manual Verification (Additional Checks)

Before ANY commit affecting pike-scripts/ or packages/:

1. **Pike compiles**: `pike -e 'compile_file("pike-scripts/analyzer.pike");'`

2. **Bridge works**: Test that PikeBridge can call methods and get responses
   ```bash
   cd packages/pike-bridge && pnpm test
   ```

3. **LSP features work**: Document symbols, hover, go-to-definition return data (not null)
   - Open a .pike file in VSCode with the extension
   - Verify hover shows type info
   - Verify Outline view shows symbols

4. **Check stderr for errors**: Pike errors go to stderr, watch for them

### Quick Smoke Test

```bash
# This MUST return JSON with symbols, not timeout or error
echo '{"jsonrpc":"2.0","id":1,"method":"introspect","params":{"code":"int x;","filename":"test.pike"}}' \
  | timeout 5 pike pike-scripts/analyzer.pike 2>&1
```

### Debugging E2E Test Failures

**Symptom:** "Should return symbols (not null)" fails
**Cause:** Document symbols not returned by LSP
**Debug:**
1. Check Pike analyzer compiles: `pike -e 'compile_file("pike-scripts/analyzer.pike");'`
2. Check Bridge works: `cd packages/pike-bridge && pnpm test`
3. Check LSP server logs: Look for "Error" in extension output
4. Manual test: Open .pike file in VSCode, check Outline view

**Symptom:** Test times out
**Cause:** LSP server not starting
**Debug:**
1. Check extension activates: VSCode "Output" -> "Pike Language Server"
2. Increase timeout in test (current: 30-60s)
3. Check Pike process: `ps aux | grep pike`

**Symptom:** "Should return hover info" fails
**Cause:** Hover handler returning null/empty
**Debug:**
1. Verify Pike analysis returns type information
2. Check LSP server hover handler for errors
3. Test with simple code: `int x;` hover on `int`

**Symptom:** "Should go to definition" fails
**Cause:** Definition handler not resolving symbols
**Debug:**
1. Check symbol is indexed (run document symbols first)
2. Verify Pike returns location with line/column
3. Test with local function: `void foo() {}` then F12 on `foo`

## Architecture Overview

```
VSCode Extension (vscode-pike)
    |
    v
TypeScript LSP Server (pike-lsp-server)
    |
    v
PikeBridge (pike-bridge) -- JSON-RPC over stdin/stdout
    |
    v
Pike Analyzer (pike-scripts/analyzer.pike)
    |
    v
LSP Modules (LSP.pmod/*)
```

## Key Files

- `pike-scripts/analyzer.pike` - Pike subprocess entry point
- `pike-scripts/LSP.pmod/` - Pike LSP modules
- `packages/pike-bridge/` - TypeScript <-> Pike IPC
- `packages/pike-lsp-server/` - LSP protocol implementation
- `packages/vscode-pike/` - VSCode extension

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Jan 20, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #4016 | 10:40 AM | ðŸŸ£ | GSD uncommitted planning mode enabled for pike-lsp project | ~204 |
</claude-mem-context>